---
import { Icon } from 'astro-icon/components'
---

<!-- search bar -->
<div
	id='search-bar'
	class={`
		hidden
		lg:block
	`}
>
	<div
		class={`
			flex h-10 flex-row rounded-lg bg-black/5
			dark:bg-white/5
		`}
	>
		<label
			for='search-bar-input'
			class={`
				flex h-10 w-10 flex-row items-center justify-center pr-1 pl-2 text-gray-400
				hover:cursor-text
			`}
		>
			<Icon name='line-md:search' width={24} height={24} />
		</label>
		<input
			id='search-bar-input'
			class={`
				w-36 bg-transparent text-foreground transition-all outline-none
				placeholder:text-foreground-lighten
				xl:focus:w-60
			`}
			placeholder='検索'
			type='text'
			autocomplete='off'
		/>
	</div>
</div>

<!-- result panel -->
<div
	id='search-result-panel'
	class={`
		absolute! top-20 -right-3 h-0 max-h-[436px] w-md overflow-y-scroll rounded-2xl bg-card opacity-0 transition-all
	`}
>
	<div
		id='search-result-list'
		class={`
			flex h-full onload-animation flex-col
			before:pt-2 before:content-['']
			after:pb-2 after:content-['']
		`}
	>
		<!-- 検索結果はJavaScriptで動的に挿入 -->
	</div>
</div>

<script>
	import { OverlayScrollbars } from 'overlayscrollbars'

	// 検索結果の型定義
	interface SearchResult {
		url: string
		meta: {
			title: string
		}
		excerpt: string
	}

	// 定数
	const RESULT_ITEM_HEIGHT = 84
	const RESULT_PANEL_PADDING = 16

	// DOM要素への参照
	const resultPanel = document.getElementById('search-result-panel') as HTMLDivElement
	const resultList = document.getElementById('search-result-list') as HTMLDivElement
	const searchBar = document.getElementById('search-bar') as HTMLDivElement
	const searchInput = document.getElementById('search-bar-input') as HTMLInputElement

	// オーバーレイスクロールバーの設定
	OverlayScrollbars(resultPanel, {
		scrollbars: {
			theme: 'scrollbar-base scrollbar-auto py-1',
			autoHide: 'move',
		},
	})

	/**
	 * 検索結果をHTMLとしてレンダリング
	 */
	const renderSearchResults = (results: SearchResult[]): void => {
		resultList.innerHTML = results
			.map(
				(item) => `
			<a
				href="${item.url}"
				class="mx-2 py-2 px-3 rounded-xl result-item transition-all hover:bg-black/5 dark:hover:bg-white/5"
			>
				<div class="flex flex-row space-x-1 items-center">
					<p class="line-clamp-1 text-lg font-semibold text-foreground result-title">
						${item.meta.title}
					</p>
					<span class="text-primary font-extrabold">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 6l6 6l-6 6"/></svg>
					</span>
				</div>
				<div>
					<div class="h-10">
						<p class="item-excerpt text-sm line-clamp-2 text-foreground-lighten">
							${item.excerpt}
						</p>
					</div>
				</div>
			</a>
		`
			)
			.join('')
	}

	/**
	 * 結果パネルの表示/非表示を制御
	 */
	const updateResultPanelVisibility = (results: SearchResult[], keyword: string): void => {
		const searchResultVisible = keyword !== '' && results.length !== 0

		if (searchResultVisible) {
			resultPanel.style.height = `${results.length * RESULT_ITEM_HEIGHT + RESULT_PANEL_PADDING}px`
			resultPanel.style.opacity = '100%'
		} else {
			resultPanel.style.height = '0px'
			resultPanel.style.opacity = '0'
		}
	}

	/**
	 * キーワードに基づいて非同期検索を実行
	 */
	const search = async (keyword: string): Promise<void> => {
		try {
			const searchResultArr: SearchResult[] = []

			if (keyword.trim()) {
				const ret = await pagefind.search(keyword)
				for (const item of ret.results) {
					searchResultArr.push(await item.data())
				}
			}

			renderSearchResults(searchResultArr)
			updateResultPanelVisibility(searchResultArr, keyword)
		} catch (error) {
			console.error('検索中にエラーが発生しました:', error)
			renderSearchResults([])
			resultPanel.style.height = '0px'
			resultPanel.style.opacity = '0'
		}
	}

	/**
	 * 外部クリックハンドラー
	 */
	const handleOutsideClick = (event: MouseEvent): void => {
		const target = event.target as Node

		if (!resultPanel?.contains(target) && !searchBar?.contains(target)) {
			search('')
			searchInput.value = ''
		}
	}

	// イベントリスナーの設定
	searchInput.addEventListener('input', () => {
		search(searchInput.value)
	})

	searchInput.addEventListener('focus', () => {
		search(searchInput.value)
	})

	document.addEventListener('click', handleOutsideClick)
</script>

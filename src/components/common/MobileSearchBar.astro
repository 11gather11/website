---
import { Icon } from 'astro-icon/components'
---

<div class='lg:hidden'>
	<button
		type='button'
		id='mobile-search-button'
		class={`
			flex w-11 justify-center rounded-lg py-2 text-foreground transition-all
			hover:bg-primary/10 hover:text-primary
		`}
		aria-label='検索を開く'
	>
		<Icon name='line-md:search' height={24} width={24} />
	</button>
</div>

<!-- モバイル検索バー -->
<div class='fixed top-18 left-1/2 z-20 w-full -translate-x-1/2'>
	<!-- 検索入力パネル -->
	<div
		id='mobile-search-bar'
		class={`
			absolute left-1/2 flex h-0 w-[95%] -translate-x-1/2 flex-col overflow-hidden rounded-xl bg-card px-1 opacity-0
			transition-all
			before:pt-1 before:content-['']
			after:pb-1 after:content-['']
			lg:hidden
		`}
	>
		<div class={`flex h-10 flex-row rounded-lg bg-muted/50`}>
			<label
				for='mobile-search-input'
				class={`
					flex h-10 w-10 flex-row items-center justify-center pr-1 pl-2 text-gray-400
					hover:cursor-text
				`}
			>
				<Icon name='line-md:search' width={24} height={24} />
			</label>
			<input
				id='mobile-search-input'
				class={`
					grow bg-transparent text-foreground transition-all outline-none
					placeholder:text-muted-foreground
				`}
				placeholder='検索'
				type='text'
				autocomplete='off'
				aria-label='検索キーワードを入力'
			/>
			<div id='mobile-search-loading' class='hidden items-center pr-2'>
				<Icon name='line-md:loading-loop' width={16} height={16} />
			</div>
		</div>
	</div>

	<!-- 結果パネル -->
	<div
		id='mobile-search-result-panel'
		class={`
			absolute top-14 left-1/2 max-h-[436px] w-[95%] -translate-x-1/2 overflow-y-scroll rounded-2xl bg-card transition-all
		`}
		style='height: 0px; opacity: 0'
	>
		<div
			id='mobile-search-result-list'
			class={`
				flex h-full onload-animation flex-col
				before:pt-2 before:content-['']
				after:pb-2 after:content-['']
			`}
		>
			<!-- 検索結果はJavaScriptで動的に挿入 -->
		</div>
	</div>
</div>

<script>
	import { OverlayScrollbars } from 'overlayscrollbars'

	// 検索結果の型定義
	interface SearchResult {
		url: string
		meta: {
			title: string
		}
		excerpt: string
	}

	// 定数
	const RESULT_ITEM_HEIGHT = 84
	const RESULT_PANEL_PADDING = 16
	const MAX_VISIBLE_RESULTS = 5

	// DOM要素への参照
	const resultPanel = document.getElementById('mobile-search-result-panel') as HTMLDivElement
	const resultList = document.getElementById('mobile-search-result-list') as HTMLDivElement
	const searchBar = document.getElementById('mobile-search-bar') as HTMLDivElement
	const searchButton = document.getElementById('mobile-search-button') as HTMLButtonElement
	const searchInput = document.getElementById('mobile-search-input') as HTMLInputElement
	const loadingIndicator = document.getElementById('mobile-search-loading') as HTMLDivElement

	// 状態管理
	let searchBarDisplay = false

	// オーバーレイスクロールバーの設定
	OverlayScrollbars(resultPanel, {
		scrollbars: {
			theme: 'scrollbar-base scrollbar-auto py-1',
			autoHide: 'move',
		},
	})

	/**
	 * 検索結果をHTMLとしてレンダリング
	 */
	const renderSearchResults = (results: SearchResult[]): void => {
		resultList.innerHTML = results
			.map(
				(item) => `
			<a
				href="${item.url}"
				class="mx-2 py-2 px-3 rounded-xl result-item transition-all"
				data-mobile-search-result
			>
				<div class="flex flex-row space-x-1 items-center">
					<p class="line-clamp-1 text-lg font-semibold text-foreground result-title">
						${item.meta.title}
					</p>
					<span class="text-primary font-extrabold">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 6l6 6l-6 6"/></svg>
					</span>
				</div>
				<div class="h-10">
					<p class="item-excerpt text-sm line-clamp-2 text-muted-foreground">
						${item.excerpt}
					</p>
				</div>
			</a>
		`
			)
			.join('')

		// 検索結果リンクにクリックイベントを追加
		const resultLinks = resultList.querySelectorAll('[data-mobile-search-result]')
		resultLinks.forEach((link) => {
			link.addEventListener('click', closeSearchBar)
		})
	}

	/**
	 * 結果パネルの高さと表示状態を更新
	 */
	const updateResultPanelVisibility = (results: SearchResult[], keyword: string): void => {
		const searchResultVisible = keyword !== '' && results.length > 0

		if (searchResultVisible) {
			const height = Math.min(results.length, MAX_VISIBLE_RESULTS) * RESULT_ITEM_HEIGHT + RESULT_PANEL_PADDING
			resultPanel.style.height = `${height}px`
			resultPanel.style.opacity = '100%'
		} else {
			resultPanel.style.height = '0px'
			resultPanel.style.opacity = '0'
		}
	}

	/**
	 * ローディング状態を更新
	 */
	const setLoading = (loading: boolean): void => {
		loadingIndicator.style.display = loading ? 'flex' : 'none'
	}

	/**
	 * キーワードに基づいて非同期検索を実行
	 */
	const search = async (keyword: string): Promise<void> => {
		if (!keyword.trim()) {
			renderSearchResults([])
			updateResultPanelVisibility([], keyword)
			return
		}

		try {
			setLoading(true)
			const searchResultArr: SearchResult[] = []

			const ret = await pagefind.search(keyword)

			for (const item of ret.results) {
				searchResultArr.push(await item.data())
			}

			renderSearchResults(searchResultArr)
			updateResultPanelVisibility(searchResultArr, keyword)
		} catch (error) {
			console.error('検索中にエラーが発生しました:', error)
			renderSearchResults([])
			updateResultPanelVisibility([], keyword)
		} finally {
			setLoading(false)
		}
	}

	/**
	 * 検索バーの表示/非表示を切り替え
	 */
	const toggleSearchBar = (): void => {
		searchBarDisplay = !searchBarDisplay

		if (searchBarDisplay) {
			searchBar.style.height = '3rem'
			searchBar.style.opacity = '1'
		} else {
			searchBar.style.height = '0'
			searchBar.style.opacity = '0'
			searchInput.value = ''
			search('')
		}
	}

	/**
	 * 検索バーを閉じる
	 */
	const closeSearchBar = (): void => {
		searchBarDisplay = false
		searchBar.style.height = '0'
		searchBar.style.opacity = '0'
		searchInput.value = ''
		search('')
	}

	/**
	 * 外部クリックハンドラー
	 */
	const handleOutsideClick = (event: MouseEvent): void => {
		const target = event.target as Node

		if (!resultPanel?.contains(target) && !searchBar?.contains(target) && !searchButton?.contains(target)) {
			closeSearchBar()
		}
	}

	// イベントリスナーの設定
	searchButton.addEventListener('click', toggleSearchBar)

	searchInput.addEventListener('input', () => {
		search(searchInput.value)
	})

	document.addEventListener('click', handleOutsideClick)
</script>

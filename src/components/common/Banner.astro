---
import { siteConfig } from '@/config/site'
import { getCoverImageByID } from '@/utils/cover'

interface Props {
	title?: string
	subTitle?: string
	bannerImage?: string
	slug?: string
}

const { title, subTitle, bannerImage, slug } = Astro.props

// 表示制御フラグ
const hasTitle = title !== undefined || subTitle !== undefined
const hasHeaderImg = bannerImage !== undefined || slug !== undefined

// カルーセル設定
const carouselImagesList = siteConfig.banners
const carouselAnimationTime = `${carouselImagesList.length * 6}s`

// 表示テキストの決定
const displayTitle = title ?? siteConfig.title
const displaySubtitle = subTitle ?? siteConfig.subtitle

// バナー画像URLの決定（slugが存在する場合のみgetCoverImageByIDを呼び出し）
const bannerImageUrl = bannerImage ?? (slug ? getCoverImageByID(slug) : undefined)
---

<div id="banner" class="banner onload-animation-fade-in">
	<div class="transition-main banner-inner h-full w-full">
		<!-- カルーセル表示（画像が指定されていない場合） -->
		{
			!hasHeaderImg && (
				<div class="carousel">
					<ul id="carousel_images">
						{carouselImagesList.map((img, index) => (
							<li
								class="item lozad"
								style={{ animationDelay: `${index * 6}s` }}
								data-background-image={img}
								role="img"
								aria-label={`バナー画像 ${index + 1}`}
							/>
						))}
					</ul>
				</div>
			)
		}

		<!-- 静的画像表示（画像が指定されている場合） -->
		{
			hasHeaderImg && (
				<div class="cover">
					<img class="item lozad" data-src={bannerImageUrl} alt={title ? `${title}のバナー画像` : 'バナー画像'} />
				</div>
			)
		}

		<!-- タイトル・サブタイトル表示エリア -->
		<div class="relative h-[95%] w-full">
			<div
				class={`
      absolute top-1/2 left-1/2 w-4/5 -translate-x-1/2 -translate-y-1/2
      lg:w-3/4
    `}
			>
				<div class="flex flex-col">
					<h1 class:list={[hasTitle ? 'title-normal' : 'title-index']} class="title">
						{displayTitle}
					</h1>
					<h2 class="subtitle">{displaySubtitle}</h2>
				</div>
			</div>
		</div>
	</div>

	<!-- 波のSVGアニメーション -->
	<div class="waves" id="header-waves">
		<svg
			class="waves"
			xmlns="http://www.w3.org/2000/svg"
			xmlns:xlink="http://www.w3.org/1999/xlink"
			viewBox="0 24 150 28"
			preserveAspectRatio="none"
			shape-rendering="auto"
			role="img"
			aria-label="装飾的な波のアニメーション"
		>
			<defs>
				<path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"> </path>
			</defs>
			<g class="parallax">
				<use
					xlink:href="#gentle-wave"
					x="48"
					y="0"
					class="opacity-25"
					style={{ animationDelay: '-2s', animationDuration: '7s' }}></use>
				<use
					xlink:href="#gentle-wave"
					x="48"
					y="3"
					class="opacity-50"
					style={{ animationDelay: '-3s', animationDuration: '10s' }}></use>
				<use
					xlink:href="#gentle-wave"
					x="48"
					y="5"
					class="opacity-75"
					style={{ animationDelay: '-4s', animationDuration: '13s' }}></use>
				<use xlink:href="#gentle-wave" x="48" y="7" style={{ animationDelay: '-5s', animationDuration: '20s' }}></use>
			</g>
		</svg>
	</div>
</div>

<script>
	/**
	 * カルーセルアニメーションのキーフレームを動的に生成
	 */
	const createCarouselAnimation = (): void => {
		try {
			const carouselImages = document.getElementById('carousel_images')
			const carouselImagesCount = carouselImages?.children.length ?? 0

			// 画像がない場合は何もしない
			if (carouselImagesCount === 0) {
				return
			}

			// アニメーションのキーフレームを計算
			const fadeInStart = 3
			const fadeInEnd = 8
			const fadeOutStart = 100 / carouselImagesCount
			const fadeOutEnd = fadeOutStart + 50 / carouselImagesCount

			const carouselAnimation = `
				@keyframes carousel-animation {
					0% {
						opacity: 0;
						transform: scale(1);
					}
					${fadeInStart}% {
						opacity: 1;
					}
					${fadeInEnd}% {
						opacity: 1;
						animation-timing-function: ease-out;
					}
					${fadeOutStart}% {
						opacity: 1;
					}
					${fadeOutEnd}% {
						opacity: 0;
						animation-timing-function: ease-out;
					}
					100% {
						opacity: 0;
						transform: scale(2);
					}
				}
			`

			// スタイル要素を作成・追加
			const styleElement = document.createElement('style')
			styleElement.textContent = carouselAnimation

			const bannerElement = document.getElementById('banner')

			// 既にスタイルが追加されていない場合のみ追加
			if (bannerElement && !bannerElement.querySelector('style')) {
				bannerElement.appendChild(styleElement)
			}
		} catch (error) {
			console.error('カルーセルアニメーションの初期化に失敗しました:', error)
		}
	}

	// DOM読み込み完了後に実行
	document.addEventListener('DOMContentLoaded', createCarouselAnimation)
</script>

<style define:vars={{ carouselAnimationTime }}>
	@reference '../../styles/globals.css';

	.banner {
		@apply relative h-[calc(var(--spacing-banner-height)*3/4)] opacity-100 lg:h-banner-height;
	}

	.carousel {
		@apply absolute top-0 left-0 -z-10 block h-[calc(var(--spacing-banner-height)*3/4)] w-full overflow-hidden bg-white lg:h-banner-height;
		animation-fill-mode: forwards;
	}

	.carousel::before {
		@apply absolute top-0 left-0 z-10 block h-full w-full bg-black/25 transition-all content-[''];
		@apply dark:bg-black/30;
	}

	.carousel .item {
		@apply absolute top-0 left-0 z-0 h-full w-full origin-center bg-cover bg-center bg-no-repeat opacity-0;
		animation: carousel-animation var(--carouselAnimationTime) linear infinite 0s;
		backface-visibility: hidden;
		transform-style: preserve-3d;
	}

	.cover {
		@apply absolute top-0 left-0 z-0 block h-banner-height w-full overflow-hidden bg-white;
	}

	.cover::before {
		@apply absolute top-0 left-0 z-10 block h-full w-full bg-black/25 transition-all content-[''];
		@apply dark:bg-black/30;
	}

	.cover .item {
		@apply h-full w-full object-cover;
	}

	.title {
		@apply mt-8 text-center font-title font-bold text-title drop-shadow-lg lg:mt-1;
	}

	.title-index {
		@apply mb-0 text-6xl leading-[5rem] lg:mb-1 lg:text-8xl;
	}

	.title-normal {
		@apply mb-1 text-3xl lg:text-5xl;
	}

	.subtitle {
		@apply text-center font-subtitle text-xl text-subtitle drop-shadow-md lg:text-3xl;
	}

	.waves {
		@apply absolute -bottom-[1px] h-[10vh] max-h-[9.375rem] min-h-[3.125rem] w-full;
		@apply md:h-[15vh];
	}

	.waves > .parallax use {
		@apply fill-background;
		animation: wave 25s cubic-bezier(0.5, 0.5, 0.45, 0.5) infinite;
	}

	@keyframes wave {
		0% {
			transform: translate3d(-90px, 0, 0);
		}
		100% {
			transform: translate3d(85px, 0, 0);
		}
	}

	@keyframes banner-onload-animation {
		0% {
			opacity: 0;
			height: calc(var(--spacing-banner-height) + 4rem);
		}
		100% {
			opacity: 1;
			height: var(--spacing-banner-height);
		}
	}
</style>

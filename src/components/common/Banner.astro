---
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'

import { BANNERS, SITE } from '@/config'
import { getCoverImageByID } from '@/utils/cover'

interface Props {
	title?: string
	subTitle?: string
	bannerImage?: ImageMetadata
	slug?: string
}

const { title, subTitle, bannerImage, slug } = Astro.props

// 表示制御フラグ
const hasTitle = title !== undefined || subTitle !== undefined
const hasHeaderImg = bannerImage !== undefined || slug !== undefined

// カルーセル設定
const carouselImagesList = BANNERS
const carouselAnimationTime = `${carouselImagesList.length * 6}s`

// 表示テキストの決定
const displayTitle = title ?? SITE.name
const displaySubtitle = subTitle ?? ''

// バナー画像URLの決定（slugが存在する場合のみgetCoverImageByIDを呼び出し）
const bannerImageUrl = bannerImage ?? (slug ? getCoverImageByID(slug) : undefined)
---

<div
	id='banner'
	class={`
		relative h-[calc(var(--spacing-banner-height)*3/4)] onload-animation-fade-in opacity-100
		lg:h-banner-height
	`}
>
	<div class='banner-inner h-full w-full transition-main'>
		<!-- カルーセル表示（画像が指定されていない場合） -->
		{
			!hasHeaderImg && (
				<div
					class={`
						absolute top-0 left-0 -z-10 block h-[calc(var(--spacing-banner-height)*3/4)] w-full overflow-hidden bg-white
						fill-mode-[forwards]
						lg:h-banner-height
					`}
				>
					<div
						class={`
							absolute top-0 left-0 z-10 block h-full w-full bg-black/25 transition-all content-['']
							dark:bg-black/30
						`}
					/>
					<ul id='carousel_images'>
						{carouselImagesList.map((img, index) => (
							<li
								class={`absolute top-0 left-0 z-0 h-full w-full origin-center opacity-0 backface-hidden transform-3d`}
								style={{
									animation: `carousel-animation ${carouselAnimationTime} linear infinite 0s`,
									animationDelay: `${index * 6}s`,
								}}
							>
								<Image
									src={img}
									alt={`バナー画像 ${index + 1}`}
									class='h-full w-full object-cover'
									loading={index === 0 ? 'eager' : 'lazy'}
								/>
							</li>
						))}
					</ul>
				</div>
			)
		}

		<!-- 静的画像表示（画像が指定されている場合） -->
		{
			bannerImageUrl && (
				<div class='absolute top-0 left-0 z-0 block h-banner-height w-full overflow-hidden bg-white'>
					<div
						class={`
							absolute top-0 left-0 z-10 block h-full w-full bg-black/25 transition-all content-['']
							dark:bg-black/30
						`}
					/>
					<Image
						class='h-full w-full object-cover'
						src={bannerImageUrl}
						alt={title ? `${title}のバナー画像` : 'バナー画像'}
						loading='lazy'
					/>
				</div>
			)
		}

		<!-- タイトル・サブタイトル表示エリア -->
		<div class='relative h-[95%] w-full'>
			<div
				class={`
					absolute top-1/2 left-1/2 w-4/5 -translate-x-1/2 -translate-y-1/2
					lg:w-3/4
				`}
			>
				<div class='flex flex-col'>
					<h1
						class={`
							mt-8 text-center font-title font-bold text-title drop-shadow-lg
							lg:mt-1
							${
								hasTitle
									? `
										mb-1 text-3xl
										lg:text-5xl
									`
									: `
										mb-0 text-6xl leading-20
										lg:mb-1 lg:text-8xl
									`
							}
						`}
					>
						{displayTitle}
					</h1>
					<h2
						class={`
							text-center font-subtitle text-xl text-subtitle drop-shadow-md
							lg:text-3xl
						`}
					>
						{displaySubtitle}
					</h2>
				</div>
			</div>
		</div>
	</div>

	<!-- 波のSVGアニメーション -->
	<div
		id='header-waves'
		class={`
			absolute -bottom-px h-[10vh] max-h-37.5 min-h-12.5 w-full
			md:h-[15vh]
		`}
	>
		<svg
			class={`
				absolute -bottom-px h-[10vh] max-h-37.5 min-h-12.5 w-full
				md:h-[15vh]
			`}
			xmlns='http://www.w3.org/2000/svg'
			xmlns:xlink='http://www.w3.org/1999/xlink'
			viewBox='0 24 150 28'
			preserveAspectRatio='none'
			shape-rendering='auto'
			role='img'
			aria-label='装飾的な波のアニメーション'
		>
			<defs>
				<path id='gentle-wave' d='M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z'></path>
			</defs>
			<g>
				<use
					xlink:href='#gentle-wave'
					x='48'
					y='0'
					class='wave-use fill-background opacity-25'
					style={{ animationDelay: '-2s', animationDuration: '7s' }}></use>
				<use
					xlink:href='#gentle-wave'
					x='48'
					y='3'
					class='wave-use fill-background opacity-50'
					style={{ animationDelay: '-3s', animationDuration: '10s' }}></use>
				<use
					xlink:href='#gentle-wave'
					x='48'
					y='5'
					class='wave-use fill-background opacity-75'
					style={{ animationDelay: '-4s', animationDuration: '13s' }}></use>
				<use
					xlink:href='#gentle-wave'
					x='48'
					y='7'
					class='wave-use fill-background'
					style={{ animationDelay: '-5s', animationDuration: '20s' }}></use>
			</g>
		</svg>
	</div>
</div>

<script>
	/**
	 * カルーセルアニメーションのキーフレームを動的に生成
	 */
	const createCarouselAnimation = (): void => {
		try {
			const carouselImages = document.getElementById('carousel_images')
			const carouselImagesCount = carouselImages?.children.length ?? 0

			// 画像がない場合は何もしない
			if (carouselImagesCount === 0) {
				return
			}

			// アニメーションのキーフレームを計算
			const fadeInStart = 3
			const fadeInEnd = 8
			const fadeOutStart = 100 / carouselImagesCount
			const fadeOutEnd = fadeOutStart + 50 / carouselImagesCount

			const carouselAnimation = `
				@keyframes carousel-animation {
					0% {
						opacity: 0;
						transform: scale(1);
					}
					${fadeInStart}% {
						opacity: 1;
					}
					${fadeInEnd}% {
						opacity: 1;
						animation-timing-function: ease-out;
					}
					${fadeOutStart}% {
						opacity: 1;
					}
					${fadeOutEnd}% {
						opacity: 0;
						animation-timing-function: ease-out;
					}
					100% {
						opacity: 0;
						transform: scale(2);
					}
				}
			`

			// スタイル要素を作成・追加
			const styleElement = document.createElement('style')
			styleElement.textContent = carouselAnimation

			const bannerElement = document.getElementById('banner')

			// 既にスタイルが追加されていない場合のみ追加
			if (bannerElement && !bannerElement.querySelector('style')) {
				bannerElement.appendChild(styleElement)
			}
		} catch (error) {
			console.error('カルーセルアニメーションの初期化に失敗しました:', error)
		}
	}

	// DOM読み込み完了後に実行
	document.addEventListener('DOMContentLoaded', createCarouselAnimation)
</script>

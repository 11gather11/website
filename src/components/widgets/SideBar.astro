---
import { Image } from 'astro:assets'
import { Icon } from 'astro-icon/components'

import { SITE } from '@/config'
import { getCategories, getTags } from '@/utils/articles'

// タグとカテゴリのデータを取得
const tags = await getTags()
const categories = await getCategories()

// 表示用の配列を準備（記事数の多い順でソート）
const categoryEntries = [...categories.entries()].sort((a, b) => b[1].articles.length - a[1].articles.length)
const tagEntries = [...tags.entries()].sort((a, b) => b[1].articles.length - a[1].articles.length)

// 表示制限の計算
const maxCategoryDisplay = SITE.maxCategoryCount
const maxTagDisplay = SITE.maxTagCount

const displayCategories = categoryEntries.slice(0, maxCategoryDisplay)
const displayTags = tagEntries.slice(0, maxTagDisplay)

const shouldShowCategoryMore = categoryEntries.length > maxCategoryDisplay
const shouldShowTagMore = tagEntries.length > maxTagDisplay
---

<div class='flex w-full flex-row justify-center'>
	<div class='flex flex-col space-y-3'>
		<!-- プロフィールセクション -->
		<div class='onload-animation rounded-3xl bg-card p-3' style='animation-delay: var(--onload-animation-delay);'>
			<a href='/about' class='group relative'>
				<div
					class={`
						absolute top-0 left-0 h-56 w-56 rounded-xl transition-all content-['']
						group-hover:bg-black/25
						dark:group-hover:bg-black/50
					`}
				>
				</div>
				<Image
					src={SITE.avatar}
					alt='avatar'
					class={`
						h-56 w-56 rounded-xl transition-all select-none
						hover:cursor-pointer
					`}
					loading='eager'
					fetchpriority='high'
				/>
			</a>
			<div class='mt-4'>
				<p class='text-center font-title text-xl font-semibold text-foreground'>{SITE.author}</p>
			</div>
			<p class='mt-2 text-center font-title text-foreground-lighten'>
				{SITE.sign}
			</p>
			{
				SITE.socialLinks.length > 0 && (
					<div class='mt-1 flex flex-row justify-center'>
						<div class='flex w-[184px] flex-wrap justify-center gap-2'>
							{SITE.socialLinks.map((item) => (
								<a href={item.link} target='_blank' aria-label={item.link}>
									<div
										class={`
											flex h-10 w-10 flex-col justify-center rounded-lg transition-all
											hover:brightness-75
											dark:hover:brightness-125
										`}
									>
										<div class='flex flex-row justify-center'>
											<Icon name={item.icon} size={24} class='text-primary' />
										</div>
									</div>
								</a>
							))}
						</div>
					</div>
				)
			}
		</div>

		<!-- カテゴリセクション -->
		{
			categories.size > 0 && (
				<div
					class='onload-animation space-y-2 rounded-3xl bg-card p-3'
					style='animation-delay: calc(var(--onload-animation-delay) + 1 * var(--onload-animation-interval));'
				>
					<div class='relative m-1.5 flex flex-row items-center'>
						<div class='absolute top-[3px] bottom-[3px] w-1.5 rounded bg-primary' />
						<a
							href='/categories/'
							class={`
								pl-4 font-primary text-xl font-bold text-foreground transition-colors
								hover:text-primary
							`}
						>
							カテゴリー
						</a>
					</div>
					<div class='relative flex flex-col'>
						{displayCategories.map(([categorySlug, categoryData]) => (
							<a
								href={`/categories/${categorySlug}`}
								class={`
									group flex flex-row items-center justify-between rounded-lg px-3 py-2 font-primary transition-all
									hover:bg-primary-lighten
								`}
							>
								<p
									class={`
										text-foreground transition-all
										group-hover:pl-2 group-hover:text-primary
									`}
								>
									{categoryData.name}
								</p>
								<span class='rounded-md bg-primary-lighten px-2.5 py-0.5 text-primary'>
									{categoryData.articles.length}
								</span>
							</a>
						))}
						{shouldShowCategoryMore && (
							<div
								class={`
									absolute bottom-0 flex h-11 w-full flex-row items-center justify-center bg-linear-to-t from-card from-25%
									to-transparent backdrop-blur-sm
								`}
							>
								<a
									href='/categories/'
									class={`
										flex flex-row items-center space-x-1 text-primary transition-colors
										hover:brightness-75
										dark:hover:brightness-125
									`}
								>
									<span>もっと見る</span>
									<Icon name='tabler:chevron-right' />
								</a>
							</div>
						)}
					</div>
				</div>
			)
		}

		<!-- タグセクション -->
		{
			tags.size > 0 && (
				<div
					class='onload-animation space-y-2 rounded-3xl bg-card p-3'
					style='animation-delay: calc(var(--onload-animation-delay) + 2 * var(--onload-animation-interval));'
				>
					<div class='relative m-1.5 flex flex-row items-center'>
						<div class='absolute top-[3px] bottom-[3px] w-1.5 rounded bg-primary' />
						<a
							href='/tags/'
							class={`
								pl-4 font-primary text-xl font-bold text-foreground transition-colors
								hover:text-primary
							`}
						>
							タグ
						</a>
					</div>
					<div class='relative flex max-w-56 flex-row flex-wrap'>
						{displayTags.map(([tagSlug, tagData]) => (
							<a
								href={`/tags/${tagSlug}`}
								class={`
									m-1 grow rounded-md bg-primary-lighten px-2 py-1 font-primary transition-all
									hover:brightness-95
								`}
							>
								<p class='text-center text-sm text-primary'>{tagData.name}</p>
							</a>
						))}
						{shouldShowTagMore && (
							<div
								class={`
									absolute bottom-0 flex h-10 w-full flex-row items-center justify-center bg-linear-to-t from-card from-25%
									to-transparent backdrop-blur-sm
								`}
							>
								<a
									href='/tags/'
									class={`
										flex flex-row items-center space-x-1 text-primary transition-colors
										hover:brightness-75
										dark:hover:brightness-125
									`}
								>
									<span>もっと見る</span>
									<Icon name='tabler:chevron-right' />
								</a>
							</div>
						)}
					</div>
				</div>
			)
		}
	</div>
</div>

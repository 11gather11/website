---
import { Icon } from 'astro-icon/components'

import MobileSearchBar from '@/components/common/MobileSearchBar.astro'
import SearchBar from '@/components/common/SearchBar.astro'
import { siteConfig } from '@/config/site'

const navCount = siteConfig.navigators.length
---

<header
	id='header-bar'
	class={`
		fixed left-1/2 z-10 flex w-full header-onload flex-col justify-end rounded-b-xl bg-card-transparent px-2.5
		backdrop-blur-md transition-all select-none
		lg:w-page-width-lg lg:rounded-b-2xl
		xl:w-page-width-xl
	`}
>
	<div
		class={`
			relative flex h-16 w-full items-center justify-between overflow-visible
			lg:h-18
		`}
	>
		<!-- モバイル: ブランド + メニューボタン -->
		<div
			class={`
				flex w-full flex-row items-center justify-between
				lg:hidden
			`}
		>
			<button
				id='menu-switcher'
				type='button'
				class={`
					mr-2 flex h-11 w-11 flex-row items-center rounded-lg text-foreground transition-all
					hover:bg-primary-hover hover:text-primary
				`}
				aria-label='メニューを開く/閉じる'
			>
				<Icon id='menu-icon-static' size={24} name='line-md:menu' class='mx-auto' />
				<Icon id='menu-icon-closed' size={24} name='line-md:close-to-menu-transition' class='mx-auto hidden' />
				<Icon id='menu-icon-opened' size={24} name='line-md:menu-to-close-transition' class='mx-auto hidden' />
			</button>
			<a
				href='/'
				class={`
					absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 truncate rounded-lg px-4 py-2 font-brand text-2xl
					font-medium text-primary transition-all
					hover:bg-primary-hover
				`}
			>
				{siteConfig.brandTitle}
			</a>
		</div>

		<!-- デスクトップ: ブランド -->
		<a
			href='/'
			class={`
				hidden h-13 rounded-lg px-5 font-medium transition-all
				hover:bg-primary-hover
				active:scale-95
				lg:block
			`}
		>
			<div class='flex h-full flex-row content-center items-center space-x-2 font-brand text-2xl text-primary'>
				<Icon name='line-md:home-md' size={32} />
				<p>{siteConfig.brandTitle}</p>
			</div>
		</a>

		<!-- デスクトップ: ナビゲーション -->
		<nav
			class={`
				absolute left-1/2 hidden -translate-x-1/2 items-center justify-between space-x-1 text-lg text-foreground opacity-85
				lg:flex
			`}
			aria-label='メインナビゲーション'
		>
			{
				siteConfig.navigators.map((item) => (
					<a
						href={item.href}
						class={`
							flex h-13 items-center rounded-lg px-6 transition-all
							hover:bg-primary-hover hover:text-primary
							active:scale-95
						`}
					>
						<p class='font-primary leading-normal font-medium'>{item.name}</p>
					</a>
				))
			}
		</nav>

		<!-- ツールバー: 検索 + テーマ切り替え -->
		<div
			class={`
				flex flex-row items-center justify-end space-x-1
				lg:mr-2
			`}
		>
			<div class='lg:hidden'>
				<MobileSearchBar />
			</div>
			<div
				class={`
					hidden
					lg:block
				`}
			>
				<SearchBar />
			</div>
			<div>
				<button
					type='button'
					id='theme-switcher'
					class={`
						flex w-11 justify-center rounded-lg py-2 text-foreground transition-all
						hover:bg-primary-hover hover:text-primary
					`}
					aria-label='テーマを切り替える'
				>
					<Icon id='theme-icon-static-light' name='line-md:sunny-outline-loop' size={24} class='hidden' />
					<Icon id='theme-icon-static-dark' name='line-md:moon-alt-loop' size={24} class='hidden' />
					<Icon
						id='theme-icon-light'
						name='line-md:moon-alt-to-sunny-outline-loop-transition'
						size={24}
						class='hidden'
					/>
					<Icon
						id='theme-icon-dark'
						name='line-md:sunny-outline-to-moon-alt-loop-transition'
						size={24}
						class='hidden'
					/>
				</button>
			</div>
		</div>
	</div>

	<!-- モバイル: ナビゲーションメニュー -->
	<nav id='mobile-menu' class='px-3 transition-all' aria-label='モバイルナビゲーション'>
		<ul
			id='mobile-menu-nav'
			data-nav-count={navCount}
			class={`
				flex h-0 flex-col space-y-6 overflow-hidden text-xl font-medium text-foreground opacity-0 transition-all
				duration-300
			`}
		>
			{
				siteConfig.navigators.map((item) => (
					<li class='mt-1'>
						<a href={item.href} data-mobile-nav-item class='flex flex-row items-center justify-between font-primary'>
							<div class='flex flex-row items-center space-x-2'>
								<span class='text-primary'>·</span>
								<span>{item.name}</span>
							</div>
							<Icon name='tabler:chevron-right' class='text-foreground-lighten' />
						</a>
					</li>
				))
			}
		</ul>
	</nav>
</header>

<script>
	/**
	 * SVGアイコンを再初期化（クローンして置き換え）
	 *
	 * @param icon - 再初期化するSVG要素
	 * @returns クローンされた新しいSVG要素
	 */
	const reinitializeIcon = (icon: SVGElement): SVGElement => {
		const cloned = icon.cloneNode(true) as SVGElement
		icon.parentNode?.replaceChild(cloned, icon)
		return cloned
	}

	/**
	 * DOM要素を安全に取得
	 *
	 * @param id - 要素のID
	 * @param elementType - 期待する要素の型名（エラーメッセージ用）
	 * @returns 見つかった要素
	 * @throws 要素が見つからない場合はエラー
	 */
	const getElementSafely = <T extends Element>(id: string, elementType: string): T => {
		const element = document.getElementById(id) as T | null
		if (!element) {
			throw new Error(`${elementType} element with id "${id}" not found`)
		}
		return element
	}

	// DOM要素を安全に取得
	const menuSwitcher = getElementSafely<HTMLButtonElement>('menu-switcher', 'Menu switcher')
	const mobileMenuNav = getElementSafely<HTMLUListElement>('mobile-menu-nav', 'Mobile menu nav')
	const mobileMenuNavItems = document.querySelectorAll('[data-mobile-nav-item]')

	// 静的アイコンとアニメーションアイコンを取得
	const menuIconStatic = getElementSafely<SVGElement>('menu-icon-static', 'Menu icon static')
	let menuIconClosed = getElementSafely<SVGElement>('menu-icon-closed', 'Menu icon closed')
	let menuIconOpened = getElementSafely<SVGElement>('menu-icon-opened', 'Menu icon opened')

	// メニューの状態管理
	let isMenuOpen = false
	const navCount = Number(mobileMenuNav.dataset.navCount) || 0

	/**
	 * メニューの開閉状態を切り替え
	 */
	const switchMenuState = (): void => {
		try {
			if (isMenuOpen) {
				// メニューを閉じる: バツ → 3本線
				menuIconStatic.style.display = 'none'
				menuIconOpened.style.display = 'none'
				menuIconClosed.style.display = 'block'
				menuIconClosed = reinitializeIcon(menuIconClosed)
			} else {
				// メニューを開く: 3本線 → バツ
				menuIconStatic.style.display = 'none'
				menuIconClosed.style.display = 'none'
				menuIconOpened.style.display = 'block'
				menuIconOpened = reinitializeIcon(menuIconOpened)
			}

			// メニューの開閉スタイル切り替え
			if (isMenuOpen) {
				// 閉じる
				mobileMenuNav.style.height = '0'
				mobileMenuNav.classList.add('opacity-0')
			} else {
				// 開く
				mobileMenuNav.style.height = `${navCount * 52}px`
				mobileMenuNav.classList.remove('opacity-0')
			}

			isMenuOpen = !isMenuOpen
		} catch (error) {
			console.error('メニュー状態の切り替えに失敗しました:', error)
		}
	}

	/**
	 * 外部クリックでメニューを閉じる
	 */
	const handleOutsideClick = (event: MouseEvent): void => {
		const target = event.target as Node

		if (!menuSwitcher.contains(target) && !mobileMenuNav.contains(target) && isMenuOpen) {
			switchMenuState()
		}
	}

	// イベントリスナーの設定
	menuSwitcher.addEventListener('click', switchMenuState)

	// モバイルメニュー項目のクリックイベント
	Array.from(mobileMenuNavItems).forEach((item) => {
		item.addEventListener('click', switchMenuState)
	})

	// 外部クリックイベント
	document.addEventListener('click', handleOutsideClick)

	// テーマ切り替え機能
	const themeSwitcher = getElementSafely<HTMLButtonElement>('theme-switcher', 'Theme switcher')

	// 静的アイコンとアニメーションアイコンを取得
	const themeIconStaticLight = getElementSafely<SVGElement>('theme-icon-static-light', 'Theme icon static light')
	const themeIconStaticDark = getElementSafely<SVGElement>('theme-icon-static-dark', 'Theme icon static dark')
	let themeIconLight = getElementSafely<SVGElement>('theme-icon-light', 'Theme icon light')
	let themeIconDark = getElementSafely<SVGElement>('theme-icon-dark', 'Theme icon dark')

	// 現在のテーマを記録
	let currentTheme = localStorage.getItem('theme') || 'light'

	/**
	 * テーマを設定（初期化用）
	 *
	 * @param theme - 設定するテーマ（'light' または 'dark'）
	 */
	const setTheme = (theme: string): void => {
		try {
			document.documentElement.setAttribute('data-theme', theme)
			localStorage.setItem('theme', theme)
			currentTheme = theme

			// 静的アイコンの表示
			themeIconStaticLight.style.display = theme === 'light' ? 'block' : 'none'
			themeIconStaticDark.style.display = theme === 'dark' ? 'block' : 'none'

			// アニメーションアイコンは非表示
			themeIconLight.style.display = 'none'
			themeIconDark.style.display = 'none'

			// ダーククラスの切り替え
			document.documentElement.classList.toggle('dark', theme === 'dark')
		} catch (error) {
			console.error('テーマの設定に失敗しました:', error)
		}
	}

	/**
	 * テーマを切り替え（アニメーション付き）
	 */
	const switchTheme = (): void => {
		try {
			const newTheme = currentTheme === 'light' ? 'dark' : 'light'

			// 静的アイコンを非表示
			themeIconStaticLight.style.display = 'none'
			themeIconStaticDark.style.display = 'none'

			// アニメーションアイコンを表示して再初期化
			if (newTheme === 'dark') {
				themeIconLight.style.display = 'none'
				themeIconDark.style.display = 'block'
				themeIconDark = reinitializeIcon(themeIconDark)
			} else {
				themeIconDark.style.display = 'none'
				themeIconLight.style.display = 'block'
				themeIconLight = reinitializeIcon(themeIconLight)
			}

			// テーマを更新
			document.documentElement.setAttribute('data-theme', newTheme)
			localStorage.setItem('theme', newTheme)
			currentTheme = newTheme
			document.documentElement.classList.toggle('dark', newTheme === 'dark')
		} catch (error) {
			console.error('テーマの切り替えに失敗しました:', error)
		}
	}

	// テーマ切り替えイベント
	themeSwitcher.addEventListener('click', switchTheme)

	// 初期化処理 - 静的アイコンのみ表示
	document.addEventListener('DOMContentLoaded', () => {
		setTheme(currentTheme)
		// 静的アイコンは setTheme で設定されるので、追加処理は不要
	})

	// スクロール時のヘッダー折りたたみ
	const headerElement = getElementSafely<HTMLElement>('header-bar', 'Header bar')
	const bannerElement = document.getElementById('banner')

	if (bannerElement) {
		const bannerHeight = bannerElement.offsetHeight - 50
		let lastYPos = 0

		const handleScroll = (): void => {
			const currentYPos = window.scrollY

			if (bannerHeight < currentYPos && currentYPos > lastYPos) {
				headerElement.style.top = '-72px'
			} else {
				headerElement.style.top = '0'
			}

			lastYPos = currentYPos
		}

		window.addEventListener('scroll', handleScroll)
	}
</script>

<script is:inline>
	/**
	 * Pagefindの初期化
	 */
	const loadPagefind = async () => {
		try {
			const pagefind = await import('/pagefind/pagefind.js')
			await pagefind.options({
				excerptLength: 20,
			})
			pagefind.init()
			window.pagefind = pagefind
			pagefind.search('')
		} catch (error) {
			console.error('Pagefindの読み込みに失敗しました:', error)
		}
	}
	loadPagefind()
</script>

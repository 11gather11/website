---
import { Icon } from 'astro-icon/components'

import { siteConfig } from '@/config/site'
import { getCategories, getTags } from '@/utils/articles'

// タグとカテゴリのデータを取得
const tags = await getTags()
const categories = await getCategories()

// 表示用の配列を準備（記事数の多い順でソート）
const categoryEntries = [...categories.entries()].sort((a, b) => b[1].articles.length - a[1].articles.length)
const tagEntries = [...tags.entries()].sort((a, b) => b[1].articles.length - a[1].articles.length)

// 表示制限の計算
const maxCategoryDisplay = siteConfig.maxSidebarCategoryChip
const maxTagDisplay = siteConfig.maxSidebarTagChip

const displayCategories = categoryEntries.slice(0, maxCategoryDisplay)
const displayTags = tagEntries.slice(0, maxTagDisplay)

const shouldShowCategoryMore = categoryEntries.length > maxCategoryDisplay
const shouldShowTagMore = tagEntries.length > maxTagDisplay
---

<div class='flex w-full flex-row justify-center'>
	<div class='flex flex-col space-y-3'>
		<!-- プロフィールセクション -->
		<div class='onload-animation rounded-3xl bg-card p-3' style='animation-delay: var(--onload-animation-delay);'>
			<a href='/about' class='avatar-wrapper'>
				<img src={siteConfig.avatarUrl} alt='avatar' class='avatar lozad select-none' />
			</a>
			<div class='username mt-4'>
				<p>{siteConfig.username}</p>
			</div>
			<p class='slogan mt-2 text-center text-foreground-lighten'>
				{siteConfig.sign}
			</p>
			{
				siteConfig.socialLinks.length > 0 && (
					<div class='mt-1 flex flex-row justify-center'>
						<div class='flex w-[184px] flex-wrap justify-center gap-2'>
							{siteConfig.socialLinks.map((item) => (
								<a href={item.link} target='_blank'>
									<div
										class={`flex h-10 w-10 flex-col justify-center rounded-lg transition-all hover:brightness-75 dark:hover:brightness-125`}
									>
										<div class='flex flex-row justify-center'>
											<Icon name={item.icon} size={24} class='text-primary' />
										</div>
									</div>
								</a>
							))}
						</div>
					</div>
				)
			}
		</div>

		<!-- カテゴリセクション -->
		{
			categories.size > 0 && (
				<div
					class='onload-animation space-y-2 rounded-3xl bg-card p-3'
					style='animation-delay: calc(var(--onload-animation-delay) + 1 * var(--onload-animation-interval));'
				>
					<div class='title m-[0.375rem]'>
						<a
							href='/categories/'
							class={`pl-4 text-xl font-bold text-foreground transition-colors hover:text-primary`}
						>
							カテゴリー
						</a>
					</div>
					<div class='relative flex flex-col'>
						{displayCategories.map(([categorySlug, categoryData]) => (
							<a
								href={`/categories/${categorySlug}`}
								class={`category flex flex-row items-center justify-between rounded-lg px-3 py-2 transition-all hover:bg-primary-lighten`}
							>
								<p class='text-foreground transition-all'>{categoryData.name}</p>
								<span class='rounded-md bg-primary-lighten px-2.5 py-0.5 text-primary'>
									{categoryData.articles.length}
								</span>
							</a>
						))}
						{shouldShowCategoryMore && (
							<div
								class={`absolute bottom-0 flex h-11 w-full flex-row items-center justify-center bg-gradient-to-t from-card from-25% to-transparent backdrop-blur-sm`}
							>
								<a
									href='/categories/'
									class={`flex flex-row items-center space-x-1 text-primary transition-colors hover:brightness-75 dark:hover:brightness-125`}
								>
									<span>もっと見る</span>
									<Icon name='tabler:chevron-right' />
								</a>
							</div>
						)}
					</div>
				</div>
			)
		}

		<!-- タグセクション -->
		{
			tags.size > 0 && (
				<div
					class='onload-animation space-y-2 rounded-3xl bg-card p-3'
					style='animation-delay: calc(var(--onload-animation-delay) + 2 * var(--onload-animation-interval));'
				>
					<div class='title m-[0.375rem]'>
						<a href='/tags/' class={`pl-4 text-xl font-bold text-foreground transition-colors hover:text-primary`}>
							タグ
						</a>
					</div>
					<div class='relative flex max-w-[224px] flex-row flex-wrap'>
						{displayTags.map(([tagSlug, tagData]) => (
							<a
								href={`/tags/${tagSlug}`}
								class={`tag m-1 grow rounded-md bg-primary-lighten px-2 py-1 transition-all hover:brightness-95`}
							>
								<p class='text-center text-sm text-primary'>{tagData.name}</p>
							</a>
						))}
						{shouldShowTagMore && (
							<div
								class={`absolute bottom-0 flex h-10 w-full flex-row items-center justify-center bg-gradient-to-t from-card from-25% to-transparent backdrop-blur-sm`}
							>
								<a
									href='/tags/'
									class={`flex flex-row items-center space-x-1 text-primary transition-colors hover:brightness-75 dark:hover:brightness-125`}
								>
									<span>もっと見る</span>
									<Icon name='tabler:chevron-right' />
								</a>
							</div>
						)}
					</div>
				</div>
			)
		}
	</div>
</div>

<style>
	@reference '../../styles/globals.css';

	.avatar-wrapper::after {
		@apply absolute top-3 left-3 h-56 w-56 rounded-xl transition-all content-[''];
	}

	.avatar-wrapper:hover::after {
		@apply bg-black/25 dark:bg-black/50;
	}

	.avatar {
		@apply h-56 w-56 rounded-xl transition-all hover:cursor-pointer;
	}

	.username > p {
		@apply text-center font-title text-xl font-semibold text-foreground;
	}

	.username > div {
		@apply mx-auto mt-1 h-1 w-8 rounded-full bg-primary;
	}

	.slogan {
		@apply font-title;
	}

	.title {
		display: flex;
		flex-direction: row;
		align-items: center;
		position: relative;
	}

	.title::before {
		position: absolute;
		display: block;
		content: ' ';
		background-color: var(--color-primary);
		top: 3px;
		bottom: 3px;
		width: 0.3rem;
		border-radius: 4px;
	}

	.title p {
		@apply font-primary;
	}

	.category {
		@apply font-primary;
	}

	.category:hover > p {
		@apply pl-2 text-primary;
	}

	.tag {
		@apply font-primary;
	}
</style>

---
import { Icon } from 'astro-icon/components'

import { siteConfig } from '@/config/site'
import { getCategories, getTags } from '@/utils/articles'

// タグとカテゴリのデータを取得
const categories = await getCategories()
const tags = await getTags()

// 表示用の配列を準備
const categoryEntries = [...categories.entries()].sort(
	(a, b) => b[1].articles.length - a[1].articles.length
)
const tagEntries = [...tags.entries()].sort(
	(a, b) => b[1].articles.length - a[1].articles.length
)

// 表示制限の計算
const maxCategoryDisplay = siteConfig.maxFooterCategoryChip
const maxTagDisplay = siteConfig.maxFooterTagChip

const displayCategories = categoryEntries.slice(0, maxCategoryDisplay)
const displayTags = tagEntries.slice(0, maxTagDisplay + 1)

const shouldShowCategoryMore = categoryEntries.length > maxCategoryDisplay
const shouldShowTagMore = tagEntries.length > maxTagDisplay + 1

// カテゴリの追加表示項目（「もっとみる」の上に表示される項目）
const additionalCategory = shouldShowCategoryMore
	? categoryEntries[maxCategoryDisplay]
	: null
---

<div class='mx-3 space-y-4'>
	<!-- オーナー情報カード -->
	<div class={`
   bg-card rounded-3xl transition-all
   lg:hidden
 `}>
		<div class={`
    flex flex-row
    md:flex-col md:pt-4
  `}>
			<a href='/about' class={`
     relative h-40 w-40
     md:hidden
   `}>
				<img
					class='lozad absolute top-0 left-0 h-40 rounded-l-3xl'
					data-src={siteConfig.avatarUrl}
					alt='Avatar'
				/>
				<div
					class='from-card absolute top-0 right-0 h-40 w-20 bg-gradient-to-l'
				>
				</div>
			</a>
			<a
				href='/about'
				class={`
      mx-auto hidden h-40 w-40 cursor-pointer rounded-3xl transition-all
      hover:brightness-75
      md:block
    `}
			>
				<img
					class='lozad h-40 rounded-3xl'
					data-src={siteConfig.avatarUrl}
					alt='Avatar'
				/>
			</a>
			<div class='flex grow flex-col justify-center space-y-4 p-4'>
				<div class='flex flex-col items-center'>
					<a
						href='/about'
						class='text-foreground line-clamp-1 text-xl font-semibold'
					>
						{siteConfig.username}
					</a>
					<span class='bg-primary mt-1 mb-2 h-1 w-8 rounded-full'></span>
					<p class='text-foreground-lighten line-clamp-1'>
						{siteConfig.sign}
					</p>
				</div>
				{
					siteConfig.socialLinks.length > 0 && (
						<ul class={`
        mx-auto grid max-w-xs grid-cols-4 justify-items-center gap-x-6 gap-y-2
      `}>
							{siteConfig.socialLinks.map((item) => (
								<li>
									<a href={item.link} class='text-primary'>
										<Icon name={item.icon} size={24} />
									</a>
								</li>
							))}
						</ul>
					)
				}
			</div>
		</div>
	</div>

	<!-- カテゴリカード -->
	{
		categories.size > 0 && (
			<div class={`
     bg-card rounded-3xl p-4 transition-all
     lg:hidden
   `}>
				<div class='mb-2 flex flex-row items-center space-x-2 pl-1.5'>
					<span class='bg-primary h-6 w-1 rounded-full' />
					<span class='text-foreground text-xl font-semibold'>カテゴリー</span>
				</div>
				<div class={`
      relative grid grid-cols-2 gap-1
      md:grid-cols-3
    `}>
					{displayCategories.map(([categorySlug, categoryData]) => (
						<a
							href={`/categories/${categorySlug}`}
							class={`
         category flex flex-row items-center justify-between rounded-lg px-2
         py-1.5 transition-all
         hover:bg-primary-lighten
       `}
						>
							<p class='text-foreground line-clamp-1 transition-all'>
								{categoryData.name}
							</p>
							<span class='text-primary bg-primary-lighten rounded-md px-2.5 py-0.5'>
								{categoryData.articles.length}
							</span>
						</a>
					))}
					{shouldShowCategoryMore && additionalCategory && (
						<>
							<a
								href={`/categories/${additionalCategory[0]}`}
								class={`
          category col-span-2 flex flex-row items-center justify-between
          rounded-lg px-2 py-1.5 transition-all
          hover:bg-primary-lighten
          md:col-span-3
        `}
							>
								<p class='text-foreground line-clamp-1 transition-all'>
									{additionalCategory[1].name}
								</p>
								<span class='text-primary bg-primary-lighten rounded-md px-2.5 py-0.5'>
									{additionalCategory[1].articles.length}
								</span>
							</a>
							<div class={`
         from-card absolute bottom-0 flex h-11 w-full flex-row items-center
         justify-center bg-gradient-to-t from-25% to-transparent
         backdrop-blur-sm
       `}>
								<a
									href='/categories/'
									class={`
           text-primary flex flex-row items-center space-x-1 transition-colors
           hover:brightness-75
           dark:hover:brightness-125
         `}
								>
									<span>もっとみる</span>
									<Icon name='tabler:chevron-right' />
								</a>
							</div>
						</>
					)}
				</div>
			</div>
		)
	}

	<!-- タグカード -->
	{
		tags.size > 0 && (
			<div class={`
     bg-card rounded-3xl p-4 transition-all
     lg:hidden
   `}>
				<div class='mb-2 flex flex-row items-center space-x-2 pl-1.5'>
					<span class='bg-primary h-6 w-1 rounded-full' />
					<span class='text-foreground text-xl font-semibold'>タグ</span>
				</div>
				<div class='relative flex flex-row flex-wrap'>
					{displayTags.map(([tagSlug, tagData]) => (
						<a
							href={`/tags/${tagSlug}`}
							class={`
         tag bg-primary-lighten m-1 rounded-md px-2 py-1 transition-all
         hover:brightness-95
       `}
						>
							<p class='text-primary text-sm'>{tagData.name}</p>
						</a>
					))}
					{shouldShowTagMore && (
						<div class={`
        from-card absolute bottom-0 flex h-10 w-full flex-row items-center
        justify-center bg-gradient-to-t from-25% to-transparent backdrop-blur-sm
      `}>
							<a
								href='/tags/'
								class={`
          text-primary flex flex-row items-center space-x-1 transition-colors
          hover:brightness-75
          dark:hover:brightness-125
        `}
							>
								<span>もっとみる</span>
								<Icon name='tabler:chevron-right' />
							</a>
						</div>
					)}
				</div>
			</div>
		)
	}

	<!-- サイトフッター -->
	<footer>
		<div
			class={`
     divide-y divide-dashed divide-black/25 py-4
     lg:pt-0
     dark:divide-white/25
   `}
		>
			<div></div>
			<div></div>
		</div>
		<div
			class='text-foreground-lighten flex w-full flex-col items-center text-sm'
		>
			<p>
				© {new Date().getFullYear()}
				<span class='copyright-name'>
					{siteConfig.copyrightName}
				</span>
				All Rights Reserved.
			</p>
			<p>
				<a class='link' href={new URL('sitemap-index.xml', siteConfig.site)}
					>SiteMap</a
				> / <a class='link' href='/rss.xml'>RSS</a>
			</p>
		</div>
	</footer>
</div>

<style>
	@reference "../../styles/globals.css";

	.link {
		@apply text-primary transition-all hover:brightness-110;
	}

	.category {
		@apply font-primary;
	}

	.category:hover > p {
		@apply text-primary pl-2;
	}

	.copyright-name {
		@apply font-copyright font-semibold;
	}
</style>
